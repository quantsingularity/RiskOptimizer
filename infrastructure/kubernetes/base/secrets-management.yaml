# Enhanced Secrets Management for RiskOptimizer Kubernetes
---
# External Secrets Operator Configuration
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
    name: vault-backend
    namespace: riskoptimizer-prod
    labels:
        app: riskoptimizer
        component: secrets
spec:
    provider:
        vault:
            server: 'https://vault.riskoptimizer.com:8200'
            path: 'secret'
            version: 'v2'
            auth:
                kubernetes:
                    mountPath: 'kubernetes'
                    role: 'riskoptimizer-backend'
                    serviceAccountRef:
                        name: 'riskoptimizer-backend'
            caBundle: |
                -----BEGIN CERTIFICATE-----
                # Vault CA Certificate (base64 encoded)
                -----END CERTIFICATE-----

---
# External Secret for Database Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
    name: database-credentials
    namespace: riskoptimizer-prod
    labels:
        app: riskoptimizer
        component: database
spec:
    refreshInterval: 15m
    secretStoreRef:
        name: vault-backend
        kind: SecretStore
    target:
        name: riskoptimizer-database-secret
        creationPolicy: Owner
        template:
            type: Opaque
            metadata:
                labels:
                    app: riskoptimizer
                    component: database
                annotations:
                    reloader.stakater.com/match: 'true'
            data:
                url: 'postgresql://{{ .username }}:{{ .password }}@postgres.riskoptimizer.com:5432/riskoptimizer?sslmode=require'
                username: '{{ .username }}'
                password: '{{ .password }}'
                host: 'postgres.riskoptimizer.com'
                port: '5432'
                database: 'riskoptimizer'
    data:
        - secretKey: username
          remoteRef:
              key: riskoptimizer/database
              property: username
        - secretKey: password
          remoteRef:
              key: riskoptimizer/database
              property: password

---
# External Secret for Application Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
    name: app-secrets
    namespace: riskoptimizer-prod
    labels:
        app: riskoptimizer
        component: application
spec:
    refreshInterval: 15m
    secretStoreRef:
        name: vault-backend
        kind: SecretStore
    target:
        name: riskoptimizer-app-secrets
        creationPolicy: Owner
        template:
            type: Opaque
            metadata:
                labels:
                    app: riskoptimizer
                    component: application
                annotations:
                    reloader.stakater.com/match: 'true'
            data:
                JWT_SECRET: '{{ .jwt_secret }}'
                API_KEY: '{{ .api_key }}'
                ENCRYPTION_KEY: '{{ .encryption_key }}'
                REDIS_PASSWORD: '{{ .redis_password }}'
                SMTP_PASSWORD: '{{ .smtp_password }}'
                AWS_ACCESS_KEY_ID: '{{ .aws_access_key }}'
                AWS_SECRET_ACCESS_KEY: '{{ .aws_secret_key }}'
    data:
        - secretKey: jwt_secret
          remoteRef:
              key: riskoptimizer/app
              property: jwt_secret
        - secretKey: api_key
          remoteRef:
              key: riskoptimizer/app
              property: api_key
        - secretKey: encryption_key
          remoteRef:
              key: riskoptimizer/app
              property: encryption_key
        - secretKey: redis_password
          remoteRef:
              key: riskoptimizer/redis
              property: password
        - secretKey: smtp_password
          remoteRef:
              key: riskoptimizer/smtp
              property: password
        - secretKey: aws_access_key
          remoteRef:
              key: riskoptimizer/aws
              property: access_key_id
        - secretKey: aws_secret_key
          remoteRef:
              key: riskoptimizer/aws
              property: secret_access_key

---
# External Secret for TLS Certificates
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
    name: tls-certificates
    namespace: riskoptimizer-prod
    labels:
        app: riskoptimizer
        component: tls
spec:
    refreshInterval: 24h
    secretStoreRef:
        name: vault-backend
        kind: SecretStore
    target:
        name: riskoptimizer-tls-certs
        creationPolicy: Owner
        template:
            type: kubernetes.io/tls
            metadata:
                labels:
                    app: riskoptimizer
                    component: tls
                annotations:
                    cert-manager.io/issuer: 'vault-issuer'
            data:
                tls.crt: '{{ .certificate }}'
                tls.key: '{{ .private_key }}'
                ca.crt: '{{ .ca_certificate }}'
    data:
        - secretKey: certificate
          remoteRef:
              key: riskoptimizer/tls
              property: certificate
        - secretKey: private_key
          remoteRef:
              key: riskoptimizer/tls
              property: private_key
        - secretKey: ca_certificate
          remoteRef:
              key: riskoptimizer/tls
              property: ca_certificate

---
# Sealed Secret for Registry Access
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
    name: riskoptimizer-registry-secret
    namespace: riskoptimizer-prod
    labels:
        app: riskoptimizer
        component: registry
spec:
    encryptedData:
        .dockerconfigjson: AgBy3i4OJSWK+PiTySYZZU9BXlVqsxF-PTtyaQryZ8dhxnTNiaTa6JkuXdl+jHUNHuuDUem5bRyXhrrinNwiaGVk...
    template:
        type: kubernetes.io/dockerconfigjson
        metadata:
            labels:
                app: riskoptimizer
                component: registry

---
# ConfigMap for Application Configuration
apiVersion: v1
kind: ConfigMap
metadata:
    name: riskoptimizer-app-config
    namespace: riskoptimizer-prod
    labels:
        app: riskoptimizer
        component: configuration
data:
    # Application Configuration
    NODE_ENV: 'production'
    LOG_LEVEL: 'info'
    LOG_FORMAT: 'json'

    # Security Configuration
    ENABLE_AUDIT_LOGGING: 'true'
    ENABLE_ENCRYPTION: 'true'
    ENABLE_RATE_LIMITING: 'true'
    ENABLE_CORS: 'true'

    # Monitoring Configuration
    ENABLE_METRICS: 'true'
    ENABLE_TRACING: 'true'
    METRICS_PORT: '8081'
    HEALTH_PORT: '8082'

    # Database Configuration
    DATABASE_POOL_SIZE: '20'
    DATABASE_TIMEOUT: '30000'
    DATABASE_SSL_MODE: 'require'

    # Redis Configuration
    REDIS_HOST: 'redis.riskoptimizer.com'
    REDIS_PORT: '6379'
    REDIS_SSL: 'true'

    # External Services
    VAULT_ADDR: 'https://vault.riskoptimizer.com:8200'
    JAEGER_ENDPOINT: 'http://jaeger-collector:14268/api/traces'

    # Compliance Configuration
    GDPR_ENABLED: 'true'
    PCI_DSS_ENABLED: 'true'
    SOX_ENABLED: 'true'
    DATA_RETENTION_DAYS: '2555' # 7 years

    # Feature Flags
    FEATURE_RISK_CALCULATION: 'true'
    FEATURE_PORTFOLIO_ANALYSIS: 'true'
    FEATURE_COMPLIANCE_REPORTING: 'true'
    FEATURE_REAL_TIME_MONITORING: 'true'

---
# ConfigMap for Vault Agent Configuration
apiVersion: v1
kind: ConfigMap
metadata:
    name: vault-agent-config
    namespace: riskoptimizer-prod
    labels:
        app: riskoptimizer
        component: vault
data:
    agent.hcl: |
        pid_file = "/tmp/pidfile"

        vault {
          address = "https://vault.riskoptimizer.com:8200"
          ca_cert = "/vault/tls/ca.crt"
          client_cert = "/vault/tls/client.crt"
          client_key = "/vault/tls/client.key"
        }

        auto_auth {
          method "kubernetes" {
            mount_path = "auth/kubernetes"
            config = {
              role = "riskoptimizer-backend"
            }
          }

          sink "file" {
            config = {
              path = "/vault/secrets/.vault-token"
            }
          }
        }

        template {
          source = "/vault/templates/database.tpl"
          destination = "/vault/secrets/database"
          perms = 0600
        }

        template {
          source = "/vault/templates/app-secrets.tpl"
          destination = "/vault/secrets/app-secrets"
          perms = 0600
        }

---
# ConfigMap for Fluent Bit Configuration
apiVersion: v1
kind: ConfigMap
metadata:
    name: fluent-bit-config
    namespace: riskoptimizer-prod
    labels:
        app: riskoptimizer
        component: logging
data:
    fluent-bit.conf: |
        [SERVICE]
            Flush         1
            Log_Level     info
            Daemon        off
            Parsers_File  parsers.conf
            HTTP_Server   On
            HTTP_Listen   0.0.0.0
            HTTP_Port     2020

        [INPUT]
            Name              tail
            Path              /app/logs/*.log
            Parser            json
            Tag               app.logs
            Refresh_Interval  5
            Mem_Buf_Limit     50MB
            Skip_Long_Lines   On

        [FILTER]
            Name                kubernetes
            Match               app.*
            Kube_URL            https://kubernetes.default.svc:443
            Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
            Kube_Tag_Prefix     app.var.log.containers.
            Merge_Log           On
            Keep_Log            Off
            K8S-Logging.Parser  On
            K8S-Logging.Exclude Off

        [FILTER]
            Name    modify
            Match   app.*
            Add     environment production
            Add     cluster riskoptimizer
            Add     compliance.gdpr true
            Add     compliance.pci_dss true
            Add     compliance.sox true

        [OUTPUT]
            Name        forward
            Match       app.*
            Host        logstash.logging.svc.cluster.local
            Port        5044
            tls         on
            tls.verify  on
            tls.ca_file /etc/ssl/certs/ca.crt

    parsers.conf: |
        [PARSER]
            Name        json
            Format      json
            Time_Key    timestamp
            Time_Format %Y-%m-%dT%H:%M:%S.%L
            Time_Keep   On

        [PARSER]
            Name        docker
            Format      json
            Time_Key    time
            Time_Format %Y-%m-%dT%H:%M:%S.%L
            Time_Keep   On
