apiVersion: apps/v1
kind: Deployment
metadata:
    name: riskoptimizer-backend
    namespace: riskoptimizer-prod
    labels:
        app: riskoptimizer-backend
        component: api
        tier: backend
        version: v1.0.0
        environment: production
        compliance.riskoptimizer.com/pci-dss: 'true'
        compliance.riskoptimizer.com/sox: 'true'
        compliance.riskoptimizer.com/gdpr: 'true'
    annotations:
        deployment.kubernetes.io/revision: '1'
        security.riskoptimizer.com/scan-date: '2024-01-01'
        compliance.riskoptimizer.com/last-audit: '2024-01-01'
        prometheus.io/scrape: 'true'
        prometheus.io/port: '8081'
        prometheus.io/path: '/metrics'
spec:
    replicas: 3
    strategy:
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 0
    selector:
        matchLabels:
            app: riskoptimizer-backend
            component: api
    template:
        metadata:
            labels:
                app: riskoptimizer-backend
                component: api
                tier: backend
                version: v1.0.0
                environment: production
            annotations:
                prometheus.io/scrape: 'true'
                prometheus.io/port: '8081'
                prometheus.io/path: '/metrics'
                vault.hashicorp.com/agent-inject: 'true'
                vault.hashicorp.com/role: 'riskoptimizer-backend'
                vault.hashicorp.com/agent-inject-secret-database: 'secret/data/riskoptimizer/database'
                vault.hashicorp.com/agent-inject-template-database: |
                    {{- with secret "secret/data/riskoptimizer/database" -}}
                    DATABASE_URL="{{ .Data.data.url }}"
                    DATABASE_PASSWORD="{{ .Data.data.password }}"
                    {{- end -}}
        spec:
            # Security Context
            securityContext:
                runAsNonRoot: true
                runAsUser: 10001
                runAsGroup: 10001
                fsGroup: 10001
                seccompProfile:
                    type: RuntimeDefault
                supplementalGroups: [10001]

            # Service Account
            serviceAccountName: riskoptimizer-backend
            automountServiceAccountToken: true

            # Node Selection and Affinity
            nodeSelector:
                node-type: application
                security-zone: internal

            affinity:
                podAntiAffinity:
                    preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          podAffinityTerm:
                              labelSelector:
                                  matchExpressions:
                                      - key: app
                                        operator: In
                                        values:
                                            - riskoptimizer-backend
                              topologyKey: kubernetes.io/hostname
                nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                            - matchExpressions:
                                  - key: node-type
                                    operator: In
                                    values:
                                        - application
                                  - key: security-zone
                                    operator: In
                                    values:
                                        - internal

            # Tolerations
            tolerations:
                - key: 'application-workload'
                  operator: 'Equal'
                  value: 'true'
                  effect: 'NoSchedule'

            # Init Containers
            initContainers:
                - name: database-migration
                  image: riskoptimizer/backend:v1.0.0
                  command: ['sh', '-c', 'npm run migrate']
                  securityContext:
                      runAsNonRoot: true
                      runAsUser: 10001
                      runAsGroup: 10001
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      capabilities:
                          drop:
                              - ALL
                  env:
                      - name: DATABASE_URL
                        valueFrom:
                            secretKeyRef:
                                name: riskoptimizer-database-secret
                                key: url
                  volumeMounts:
                      - name: tmp-volume
                        mountPath: /tmp
                      - name: cache-volume
                        mountPath: /app/.cache
                  resources:
                      limits:
                          cpu: 500m
                          memory: 512Mi
                      requests:
                          cpu: 100m
                          memory: 256Mi

            # Main Containers
            containers:
                - name: riskoptimizer-backend
                  image: riskoptimizer/backend:v1.0.0
                  imagePullPolicy: Always

                  # Security Context
                  securityContext:
                      runAsNonRoot: true
                      runAsUser: 10001
                      runAsGroup: 10001
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      capabilities:
                          drop:
                              - ALL
                          add:
                              - NET_BIND_SERVICE

                  # Ports
                  ports:
                      - name: http
                        containerPort: 8080
                        protocol: TCP
                      - name: metrics
                        containerPort: 8081
                        protocol: TCP
                      - name: health
                        containerPort: 8082
                        protocol: TCP

                  # Environment Variables
                  env:
                      - name: NODE_ENV
                        value: 'production'
                      - name: PORT
                        value: '8080'
                      - name: METRICS_PORT
                        value: '8081'
                      - name: HEALTH_PORT
                        value: '8082'
                      - name: LOG_LEVEL
                        value: 'info'
                      - name: LOG_FORMAT
                        value: 'json'
                      - name: ENABLE_AUDIT_LOGGING
                        value: 'true'
                      - name: ENABLE_METRICS
                        value: 'true'
                      - name: ENABLE_TRACING
                        value: 'true'
                      - name: JAEGER_ENDPOINT
                        value: 'http://jaeger-collector:14268/api/traces'
                      - name: VAULT_ADDR
                        value: 'https://vault.riskoptimizer.com:8200'
                      - name: VAULT_NAMESPACE
                        value: 'riskoptimizer'
                      - name: KUBERNETES_NAMESPACE
                        valueFrom:
                            fieldRef:
                                fieldPath: metadata.namespace
                      - name: POD_NAME
                        valueFrom:
                            fieldRef:
                                fieldPath: metadata.name
                      - name: POD_IP
                        valueFrom:
                            fieldRef:
                                fieldPath: status.podIP
                      - name: NODE_NAME
                        valueFrom:
                            fieldRef:
                                fieldPath: spec.nodeName

                  # Environment from Secrets and ConfigMaps
                  envFrom:
                      - secretRef:
                            name: riskoptimizer-app-secrets
                      - configMapRef:
                            name: riskoptimizer-app-config

                  # Volume Mounts
                  volumeMounts:
                      - name: tmp-volume
                        mountPath: /tmp
                      - name: cache-volume
                        mountPath: /app/.cache
                      - name: logs-volume
                        mountPath: /app/logs
                      - name: vault-secrets
                        mountPath: /vault/secrets
                        readOnly: true
                      - name: ssl-certs
                        mountPath: /etc/ssl/certs
                        readOnly: true
                      - name: app-config
                        mountPath: /app/config
                        readOnly: true

                  # Resource Limits and Requests
                  resources:
                      limits:
                          cpu: 2000m
                          memory: 4Gi
                          ephemeral-storage: 2Gi
                      requests:
                          cpu: 500m
                          memory: 1Gi
                          ephemeral-storage: 1Gi

                  # Health Checks
                  livenessProbe:
                      httpGet:
                          path: /health/live
                          port: health
                          scheme: HTTP
                      initialDelaySeconds: 60
                      periodSeconds: 30
                      timeoutSeconds: 10
                      successThreshold: 1
                      failureThreshold: 3

                  readinessProbe:
                      httpGet:
                          path: /health/ready
                          port: health
                          scheme: HTTP
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                      successThreshold: 1
                      failureThreshold: 3

                  startupProbe:
                      httpGet:
                          path: /health/startup
                          port: health
                          scheme: HTTP
                      initialDelaySeconds: 10
                      periodSeconds: 5
                      timeoutSeconds: 3
                      successThreshold: 1
                      failureThreshold: 30

                  # Lifecycle Hooks
                  lifecycle:
                      preStop:
                          exec:
                              command:
                                  - /bin/sh
                                  - -c
                                  - 'sleep 15'

                # Sidecar Containers
                - name: vault-agent
                  image: vault:1.12.0
                  command: ['vault', 'agent', '-config=/vault/config/agent.hcl']
                  securityContext:
                      runAsNonRoot: true
                      runAsUser: 10001
                      runAsGroup: 10001
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      capabilities:
                          drop:
                              - ALL
                  volumeMounts:
                      - name: vault-config
                        mountPath: /vault/config
                        readOnly: true
                      - name: vault-secrets
                        mountPath: /vault/secrets
                  resources:
                      limits:
                          cpu: 100m
                          memory: 128Mi
                      requests:
                          cpu: 50m
                          memory: 64Mi

                - name: log-forwarder
                  image: fluent/fluent-bit:1.9.0
                  securityContext:
                      runAsNonRoot: true
                      runAsUser: 10001
                      runAsGroup: 10001
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      capabilities:
                          drop:
                              - ALL
                  volumeMounts:
                      - name: logs-volume
                        mountPath: /app/logs
                        readOnly: true
                      - name: fluent-bit-config
                        mountPath: /fluent-bit/etc
                        readOnly: true
                  resources:
                      limits:
                          cpu: 100m
                          memory: 128Mi
                      requests:
                          cpu: 50m
                          memory: 64Mi

            # Volumes
            volumes:
                - name: tmp-volume
                  emptyDir:
                      sizeLimit: 1Gi
                - name: cache-volume
                  emptyDir:
                      sizeLimit: 2Gi
                - name: logs-volume
                  emptyDir:
                      sizeLimit: 1Gi
                - name: vault-secrets
                  emptyDir:
                      medium: Memory
                      sizeLimit: 128Mi
                - name: vault-config
                  configMap:
                      name: vault-agent-config
                - name: ssl-certs
                  secret:
                      secretName: riskoptimizer-tls-certs
                      defaultMode: 0400
                - name: app-config
                  configMap:
                      name: riskoptimizer-app-config
                - name: fluent-bit-config
                  configMap:
                      name: fluent-bit-config

            # Image Pull Secrets
            imagePullSecrets:
                - name: riskoptimizer-registry-secret

            # DNS Configuration
            dnsPolicy: ClusterFirst
            dnsConfig:
                options:
                    - name: ndots
                      value: '2'
                    - name: edns0

            # Termination Grace Period
            terminationGracePeriodSeconds: 30

            # Priority and Preemption
            priorityClassName: high-priority

            # Restart Policy
            restartPolicy: Always
