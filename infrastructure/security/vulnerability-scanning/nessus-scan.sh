#!/bin/bash

# Nessus Vulnerability Scanning Script for RiskOptimizer Infrastructure
# This script automates vulnerability scanning using Nessus

set -euo pipefail

# Configuration
NESSUS_SERVER="https://nessus.riskoptimizer.com:8834"
NESSUS_USERNAME="${NESSUS_USERNAME:-admin}"
NESSUS_PASSWORD="${NESSUS_PASSWORD:-}"
SCAN_TARGETS="${SCAN_TARGETS:-10.0.0.0/8,172.16.0.0/12,192.168.0.0/16}"
SCAN_NAME="RiskOptimizer-Infrastructure-Scan-$(date +%Y%m%d-%H%M%S)"
POLICY_NAME="Advanced Scan"
REPORT_DIR="/var/log/nessus/reports"
EMAIL_RECIPIENTS="security@riskoptimizer.com"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}"
    exit 1
}

# Check dependencies
check_dependencies() {
    log "Checking dependencies..."

    if ! command -v curl >/dev/null 2>&1; then
        error "curl is required but not installed"
    fi

    if ! command -v jq >/dev/null 2>&1; then
        error "jq is required but not installed"
    fi

    if [[ -z "$NESSUS_PASSWORD" ]]; then
        error "NESSUS_PASSWORD environment variable is required"
    fi

    # Create report directory
    mkdir -p "$REPORT_DIR"

    log "Dependencies check completed"
}

# Authenticate with Nessus
authenticate() {
    log "Authenticating with Nessus server..."

    local response
    response=$(curl -s -k -X POST \
        -H "Content-Type: application/json" \
        -d "{\"username\":\"$NESSUS_USERNAME\",\"password\":\"$NESSUS_PASSWORD\"}" \
        "$NESSUS_SERVER/session")

    if [[ $? -ne 0 ]]; then
        error "Failed to connect to Nessus server"
    fi

    TOKEN=$(echo "$response" | jq -r '.token')

    if [[ "$TOKEN" == "null" || -z "$TOKEN" ]]; then
        error "Failed to authenticate with Nessus server"
    fi

    log "Authentication successful"
}

# Get policy UUID
get_policy_uuid() {
    log "Getting policy UUID for '$POLICY_NAME'..."

    local response
    response=$(curl -s -k -X GET \
        -H "X-Cookie: token=$TOKEN" \
        "$NESSUS_SERVER/editor/policy/templates")

    POLICY_UUID=$(echo "$response" | jq -r ".templates[] | select(.title==\"$POLICY_NAME\") | .uuid")

    if [[ "$POLICY_UUID" == "null" || -z "$POLICY_UUID" ]]; then
        error "Policy '$POLICY_NAME' not found"
    fi

    log "Policy UUID: $POLICY_UUID"
}

# Create scan
create_scan() {
    log "Creating scan '$SCAN_NAME'..."

    local scan_data
    scan_data=$(cat <<EOF
{
    "uuid": "$POLICY_UUID",
    "settings": {
        "name": "$SCAN_NAME",
        "description": "Automated vulnerability scan for RiskOptimizer infrastructure",
        "text_targets": "$SCAN_TARGETS",
        "agent_group_id": [],
        "emails": "$EMAIL_RECIPIENTS",
        "launch_now": false,
        "enabled": false,
        "scanner_id": "1",
        "folder_id": 3,
        "policy_id": 0
    }
}
EOF
    )

    local response
    response=$(curl -s -k -X POST \
        -H "X-Cookie: token=$TOKEN" \
        -H "Content-Type: application/json" \
        -d "$scan_data" \
        "$NESSUS_SERVER/scans")

    SCAN_ID=$(echo "$response" | jq -r '.scan.id')

    if [[ "$SCAN_ID" == "null" || -z "$SCAN_ID" ]]; then
        error "Failed to create scan"
    fi

    log "Scan created with ID: $SCAN_ID"
}

# Launch scan
launch_scan() {
    log "Launching scan..."

    local response
    response=$(curl -s -k -X POST \
        -H "X-Cookie: token=$TOKEN" \
        "$NESSUS_SERVER/scans/$SCAN_ID/launch")

    if [[ $? -ne 0 ]]; then
        error "Failed to launch scan"
    fi

    log "Scan launched successfully"
}

# Monitor scan progress
monitor_scan() {
    log "Monitoring scan progress..."

    while true; do
        local response
        response=$(curl -s -k -X GET \
            -H "X-Cookie: token=$TOKEN" \
            "$NESSUS_SERVER/scans/$SCAN_ID")

        local status
        status=$(echo "$response" | jq -r '.info.status')

        case "$status" in
            "running")
                local progress
                progress=$(echo "$response" | jq -r '.info.scan_progress')
                log "Scan in progress: ${progress}%"
                sleep 60
                ;;
            "completed")
                log "Scan completed successfully"
                break
                ;;
            "canceled"|"aborted")
                error "Scan was canceled or aborted"
                ;;
            "paused")
                warn "Scan is paused"
                sleep 60
                ;;
            *)
                warn "Unknown scan status: $status"
                sleep 60
                ;;
        esac
    done
}

# Export scan results
export_results() {
    log "Exporting scan results..."

    # Request PDF export
    local export_response
    export_response=$(curl -s -k -X POST \
        -H "X-Cookie: token=$TOKEN" \
        -H "Content-Type: application/json" \
        -d '{"format":"pdf"}' \
        "$NESSUS_SERVER/scans/$SCAN_ID/export")

    local export_token
    export_token=$(echo "$export_response" | jq -r '.token')

    if [[ "$export_token" == "null" || -z "$export_token" ]]; then
        error "Failed to initiate export"
    fi

    # Wait for export to complete
    log "Waiting for export to complete..."
    while true; do
        local status_response
        status_response=$(curl -s -k -X GET \
            -H "X-Cookie: token=$TOKEN" \
            "$NESSUS_SERVER/scans/$SCAN_ID/export/$export_token/status")

        local export_status
        export_status=$(echo "$status_response" | jq -r '.status')

        if [[ "$export_status" == "ready" ]]; then
            log "Export ready for download"
            break
        elif [[ "$export_status" == "loading" ]]; then
            log "Export in progress..."
            sleep 10
        else
            error "Export failed with status: $export_status"
        fi
    done

    # Download the report
    local report_file="$REPORT_DIR/${SCAN_NAME}.pdf"
    curl -s -k -X GET \
        -H "X-Cookie: token=$TOKEN" \
        "$NESSUS_SERVER/scans/$SCAN_ID/export/$export_token/download" \
        -o "$report_file"

    if [[ $? -eq 0 ]]; then
        log "Report downloaded: $report_file"
    else
        error "Failed to download report"
    fi

    # Also export as CSV for automated processing
    local csv_export_response
    csv_export_response=$(curl -s -k -X POST \
        -H "X-Cookie: token=$TOKEN" \
        -H "Content-Type: application/json" \
        -d '{"format":"csv"}' \
        "$NESSUS_SERVER/scans/$SCAN_ID/export")

    local csv_export_token
    csv_export_token=$(echo "$csv_export_response" | jq -r '.token')

    # Wait for CSV export
    while true; do
        local csv_status_response
        csv_status_response=$(curl -s -k -X GET \
            -H "X-Cookie: token=$TOKEN" \
            "$NESSUS_SERVER/scans/$SCAN_ID/export/$csv_export_token/status")

        local csv_export_status
        csv_export_status=$(echo "$csv_status_response" | jq -r '.status')

        if [[ "$csv_export_status" == "ready" ]]; then
            break
        elif [[ "$csv_export_status" == "loading" ]]; then
            sleep 5
        else
            error "CSV export failed"
        fi
    done

    # Download CSV report
    local csv_report_file="$REPORT_DIR/${SCAN_NAME}.csv"
    curl -s -k -X GET \
        -H "X-Cookie: token=$TOKEN" \
        "$NESSUS_SERVER/scans/$SCAN_ID/export/$csv_export_token/download" \
        -o "$csv_report_file"

    log "CSV report downloaded: $csv_report_file"
}

# Generate summary report
generate_summary() {
    log "Generating scan summary..."

    local response
    response=$(curl -s -k -X GET \
        -H "X-Cookie: token=$TOKEN" \
        "$NESSUS_SERVER/scans/$SCAN_ID")

    local critical_count
    local high_count
    local medium_count
    local low_count
    local info_count

    critical_count=$(echo "$response" | jq -r '.vulnerabilities.critical // 0')
    high_count=$(echo "$response" | jq -r '.vulnerabilities.high // 0')
    medium_count=$(echo "$response" | jq -r '.vulnerabilities.medium // 0')
    low_count=$(echo "$response" | jq -r '.vulnerabilities.low // 0')
    info_count=$(echo "$response" | jq -r '.vulnerabilities.info // 0')

    local summary_file="$REPORT_DIR/${SCAN_NAME}-summary.txt"

    cat > "$summary_file" <<EOF
RiskOptimizer Infrastructure Vulnerability Scan Summary
======================================================

Scan Name: $SCAN_NAME
Scan Date: $(date)
Targets: $SCAN_TARGETS

Vulnerability Counts:
- Critical: $critical_count
- High: $high_count
- Medium: $medium_count
- Low: $low_count
- Info: $info_count

Total Vulnerabilities: $((critical_count + high_count + medium_count + low_count))

Reports Generated:
- PDF Report: ${SCAN_NAME}.pdf
- CSV Report: ${SCAN_NAME}.csv
- Summary: ${SCAN_NAME}-summary.txt

Recommendations:
- Address critical and high severity vulnerabilities immediately
- Review medium severity vulnerabilities within 30 days
- Schedule regular vulnerability scans (weekly for critical infrastructure)
- Implement automated patch management where possible
EOF

    log "Summary report generated: $summary_file"

    # Display summary
    echo
    echo "=== SCAN SUMMARY ==="
    echo "Critical: $critical_count"
    echo "High: $high_count"
    echo "Medium: $medium_count"
    echo "Low: $low_count"
    echo "Info: $info_count"
    echo "===================="
    echo
}

# Send email notification
send_notification() {
    log "Sending email notification..."

    local subject="RiskOptimizer Vulnerability Scan Completed - $SCAN_NAME"
    local body="The vulnerability scan for RiskOptimizer infrastructure has completed.

Scan Summary:
- Critical: $(echo "$response" | jq -r '.vulnerabilities.critical // 0')
- High: $(echo "$response" | jq -r '.vulnerabilities.high // 0')
- Medium: $(echo "$response" | jq -r '.vulnerabilities.medium // 0')
- Low: $(echo "$response" | jq -r '.vulnerabilities.low // 0')

Reports are available at: $REPORT_DIR

Please review the findings and take appropriate action for critical and high severity vulnerabilities."

    if command -v mail >/dev/null 2>&1; then
        echo "$body" | mail -s "$subject" "$EMAIL_RECIPIENTS"
        log "Email notification sent"
    else
        warn "Mail command not available, skipping email notification"
    fi
}

# Cleanup
cleanup() {
    log "Cleaning up..."

    # Logout from Nessus
    if [[ -n "${TOKEN:-}" ]]; then
        curl -s -k -X DELETE \
            -H "X-Cookie: token=$TOKEN" \
            "$NESSUS_SERVER/session" >/dev/null 2>&1
    fi

    log "Cleanup completed"
}

# Main execution
main() {
    log "Starting Nessus vulnerability scan..."

    # Set up cleanup trap
    trap cleanup EXIT

    check_dependencies
    authenticate
    get_policy_uuid
    create_scan
    launch_scan
    monitor_scan
    export_results
    generate_summary
    send_notification

    log "Vulnerability scan completed successfully!"
}

# Run main function
main "$@"
